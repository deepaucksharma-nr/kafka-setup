# Kafka Share Groups Complete Dashboard

This dashboard provides comprehensive visualization of all data collected by our Kafka Share Groups monitoring setup.

## Dashboard Overview

The dashboard includes 6 pages with complete coverage of:

### 1. **Overview Page**
- Cluster health status
- Share Groups vs Traditional Groups count
- Total message backlog comparison
- Message processing timeline

### 2. **Share Group Details**
- Unacknowledged messages by share group
- Oldest message age tracking
- Processing rates per group
- Message states distribution (Unacked, Acknowledged, Released, Rejected)
- Partition-level heatmap

### 3. **Traditional vs Share Groups**
- Zero lag fallacy detection table
- Side-by-side comparison of traditional lag vs actual unacked messages
- Processing delay comparison with percentiles

### 4. **Broker Metrics**
- Network throughput (bytes in/out)
- Request rates (produce/fetch)
- Partition leadership status
- JVM memory usage
- Topic-level metrics table

### 5. **Infrastructure & OHI**
- Custom OHI execution status
- QueueSample event generation rate
- Infrastructure agent health
- Prometheus scrape metrics
- Integration errors tracking

### 6. **Alerts & Thresholds**
- Visual threshold monitoring for:
  - Unacknowledged messages (Warning: 500, Critical: 1000)
  - Message age (Warning: 120s, Critical: 300s)
  - Processing rate (Critical: 0 msgs/min = stalled)
- Alert summary billboard

## Data Sources

The dashboard aggregates data from:

1. **QueueSample Events** - Generated by our Custom OHI
   - `queue.size` - Unacknowledged messages
   - `oldest.message.age.seconds` - Processing delay
   - `messages.acknowledged` - Completion rate
   - `share.group.name`, `topic.name`, `partition.id` - Dimensions

2. **Prometheus Metrics** - Via nri-flex
   - `kafka_sharegroup_records_unacked`
   - `kafka_sharegroup_oldest_unacked_ms`
   - `kafka_sharegroup_records_acknowledged`
   - `kafka_sharegroup_records_released`
   - `kafka_sharegroup_records_rejected`

3. **Traditional Kafka Metrics** - Via nri-kafka
   - `KafkaBrokerSample` - Broker-level metrics
   - `KafkaTopicSample` - Topic-level metrics
   - Consumer lag metrics

4. **Infrastructure Metrics**
   - `SystemSample` - Host metrics
   - `IntegrationError` - Error tracking
   - `Log` - OHI execution logs

## Deployment

### Prerequisites
- New Relic API Key (User key with dashboard permissions)
- New Relic Account ID

### Deploy the Dashboard
```bash
# Set environment variables
export NEW_RELIC_API_KEY=your_api_key_here
export NEW_RELIC_ACCOUNT_ID=your_account_id_here

# Deploy the dashboard
./deploy-dashboard.sh
```

### Manual Import
1. Go to New Relic One > Dashboards
2. Click "Import dashboard"
3. Paste the contents of `kafka-sharegroups-complete-dashboard.json`
4. Update the `KAFKA_CLUSTER_NAME` variable if needed

## Dashboard Variables

The dashboard uses a variable for cluster selection:
- `KAFKA_CLUSTER_NAME` - Automatically populated from your QueueSample events

## Key Insights

### Zero Lag Fallacy Detection
The dashboard highlights cases where traditional monitoring shows zero lag but messages are still being processed (unacknowledged).

### Processing Health
Monitor three key indicators:
1. **Backlog Size** - How many messages are waiting
2. **Processing Age** - How old is the oldest unprocessed message
3. **Processing Rate** - Messages processed per minute

### Alert Thresholds
Pre-configured thresholds align with the alert policies:
- **High Backlog**: >500 (warning), >1000 (critical)
- **Old Messages**: >120s (warning), >300s (critical)
- **Stalled Processing**: 0 msgs/min (critical)

## Customization

### Adding Widgets
The dashboard JSON can be modified to add custom widgets. Common additions:
- Error rate tracking
- Consumer group specific views
- Topic-level deep dives

### Modifying Thresholds
Update threshold values in the "Alerts & Thresholds" page widgets to match your SLAs.

### Time Windows
Most widgets use `TIMESERIES AUTO` for adaptive time windows. Modify as needed for specific use cases.

## Troubleshooting

### No Data Appearing
1. Verify the Kafka monitoring stack is deployed
2. Check QueueSample events: `FROM QueueSample SELECT count(*) SINCE 10 minutes ago`
3. Verify cluster name matches your deployment
4. Check Custom OHI logs for errors

### Missing Metrics
- Traditional metrics: Check nri-kafka agent
- Share Group metrics: Verify Prometheus endpoint
- QueueSample events: Check Custom OHI execution

### Performance
If queries are slow:
- Reduce time windows
- Add more specific WHERE clauses
- Use sampling for high-volume metrics